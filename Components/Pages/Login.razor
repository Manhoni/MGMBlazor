@page "/"
@using MGMBlazor.Infrastructure.Security
@rendermode InteractiveServer

@layout Layout.EmptyLayout
@inject UserSession UserSession
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject AppDbContext DbContext

<div class="login-container">
      <div class="login-card">
            <div class="text-center mb-4">
                  <img src="mgmLogo.jpg" height="70" />
                  <h4 class="mt-3">Acesso ao Sistema</h4>
            </div>

            <div class="mb-3">
                  <label class="form-label small fw-bold text-muted">USUÁRIO</label>
                  <input type="text" class="form-control" @bind="usuario" autofocus />
            </div>

            <div class="mb-4">
                  <label class="form-label small fw-bold text-muted">SENHA</label>
                  <input type="password" class="form-control" @bind="senha" @onkeydown="TratarEnter" />
            </div>

            @if (!string.IsNullOrEmpty(erro))
            {
                  <div class="alert alert-danger py-2 small">@erro</div>
            }

            @* Note a classe dinâmica @classeAtiva para o ENTER funcionar visualmente *@
            <button id="btn-login" type="button" class="btn-login w-100 @classeAtiva" @onclick="TentarLogar"
                  disabled="@estaCarregando">

                  @if (estaCarregando)
                  {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span class="ms-2">AUTENTICANDO...</span>
                  }
                  else
                  {
                        <span>ENTRAR</span>
                  }
            </button>
      </div>
</div>
<style>
      /* Efeito visual de clique */
      .btn-login:active {
            transform: translateY(2px);
            /* Faz o botão "descer" 2 pixels */
            box-shadow: none !important;
            /* Remove a sombra pra parecer que encostou no fundo */
      }

      /* Transição suave para a animação não ser brusca */
      .btn-login {
            transition: all 0.1s ease-in-out;
      }
</style>

@code {
      private string usuario = "";
      private string senha = "";
      private string erro = "";
      private bool processando = false;
      private string classeAtiva = "";
      private bool estaCarregando = false;

      private async Task TentarLogar()
      {
            processando = true;
            Console.WriteLine("[DEBUG]>>>> BOTÃO DE LOGIN CLICADO!");
            string senhaDigitadaHash = PasswordHasher.GerarHash(senha);

            var userDb = await DbContext.Usuarios
            .FirstOrDefaultAsync(u => u.Login == usuario && u.SenhaHash == senhaDigitadaHash);

            if (userDb != null)
            {
                  UserSession.Login(userDb.Nome, userDb.IsAdmin, userDb.Role);
                  Nav.NavigateTo("/home");
                  processando = false;
            }
            else
            {
                  erro = "Usuário ou senha inválidos.";
                  processando = false;
            }
      }
      private async Task TratarEnter(KeyboardEventArgs e)
      {
            if (e.Key == "Enter" || e.Key == "NumpadEnter")
            {
                  classeAtiva = "btn-fake-active"; // Ativa o visual de "afundar"
                  StateHasChanged();

                  await Task.Delay(100); // Pequena pausa para o usuário ver o clique

                  classeAtiva = ""; // Volta ao normal
                  await TentarLogar();
            }
      }
}