@page "/clientes"
@rendermode InteractiveServer
@attribute [Authorize]

@inject IClienteService ClienteService
@inject CepService CepService
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav

<PageTitle>Cadastro de Clientes</PageTitle>

<div class="container mt-3">
      <div
            class="d-flex justify-content-between align-items-center mb-3 p-2 shadow-sm rounded bg-white border-left-mgm">
            <h4 class="m-0 fw-bold text-dark"><i class="bi bi-person-vcard"></i> Gestão de Clientes</h4>
            <button class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-file-earmark-arrow-up"></i> Importar CSV
            </button>
      </div>

      <!-- Seção de Busca Dinâmica -->
      <div class="card shadow-sm mb-4 border-0">
            <div class="card-body bg-light position-relative">
                  <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                              <label class="form-label fw-bold small text-muted">DIGITE CNPJ OU RAZÃO SOCIAL</label>
                              <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control shadow-sm"
                                           placeholder="Comece a digitar para pesquisar..." @bind="cnpjBusca"
                                           @oninput="OnInputBusca" />
                              </div>

                              @* Lista de Sugestões Autocomplete *@
                              @if (clientesSugestao.Any())
                              {
                                    <ul class="list-group position-absolute w-100 shadow-lg"
                                              style="z-index: 1050; max-height: 250px; overflow-y: auto; margin-top: 2px;">
                                          @foreach (var c in clientesSugestao)
                                          {
                                                <button class="list-group-item list-group-item-action py-2"
                                                        @onclick="() => SelecionarCliente(c)">
                                                      <div class="d-flex justify-content-between">
                                                            <span class="fw-bold">@c.RazaoSocial</span>
                                                            <span
                                                            class="badge bg-light text-muted border">@MGMFormatador.FormatarCnpj(c.Cnpj)</span>
                                                      </div>
                                                </button>
                                          }
                                    </ul>
                              }
                        </div>
                        <div class="col-md-auto">
                              <button class="btn btn-dark" @onclick="Buscar">
                                    <i class="bi bi-arrow-right-circle"></i> Abrir Cadastro
                              </button>
                              <button class="btn btn-success ms-2" @onclick="NovoCliente">
                                    <i class="bi bi-person-plus-fill"></i> Novo Cliente
                              </button>
                        </div>
                  </div>
            </div>
      </div>

      @if (exibirFormulario)
      {
            <EditForm Model="cliente" OnValidSubmit="HandleSubmit" FormName="ClienteForm">
                  <DataAnnotationsValidator />

                  <div class="card shadow">
                        <div class="card-header bg-light">
                              <h5 class="mb-0 text-primary">
                                    @(isEditMode ? "Editar Cadastro" : "Novo Cadastro")
                              </h5>
                        </div>
                        <div class="card-body">
                              <ValidationSummary class="text-danger small" />
                              <div class="row g-3">
                                    <div class="col-md-4">
                                          <label class="form-label">CNPJ *</label>
                                          <input type="text" class="form-control"
                                                 value="@MGMFormatador.FormatarCnpj(cliente.Cnpj)" maxlength="18"
                                                 @oninput="@(e => cliente.Cnpj = e.Value?.ToString() ?? "")"
                                                 placeholder="00.000.000/0000-00" />
                                    </div>
                                    <div class="col-md-8">
                                          <label class="form-label">Razão Social *</label>
                                          <InputText class="form-control" @bind-Value="cliente.RazaoSocial" />
                                    </div>
                                    <div class="col-md-4">
                                          <label class="form-label">E-mail *</label>
                                          <InputText class="form-control" @bind-Value="cliente.Email" />
                                    </div>

                                    <div class="col-md-3">
                                          <label class="form-label">CEP *</label>
                                          <input type="text" class="form-control"
                                                 value="@MGMFormatador.FormatarCep(cliente.Cep)" @oninput="OnCepInput"
                                                 maxlength="9" placeholder="00000-000" />
                                    </div>
                                    <div class="col-md-7">
                                          <label class="form-label">Endereço</label>
                                          <InputText class="form-control" @bind-Value="cliente.Endereco" />
                                    </div>
                                    <div class="col-md-2">
                                          <label class="form-label">Nº</label>
                                          <InputText class="form-control" @bind-Value="cliente.Numero" />
                                    </div>

                                    <div class="col-md-4">
                                          <label class="form-label">Bairro</label>
                                          <InputText class="form-control" @bind-Value="cliente.Bairro" />
                                    </div>
                                    <div class="col-md-4">
                                          <label class="form-label">Cidade</label>
                                          <InputText class="form-control" @bind-Value="cliente.Cidade" />
                                    </div>
                                    <div class="col-md-4">
                                          <label class="form-label">UF</label>
                                          <InputText class="form-control" @bind-Value="cliente.Uf" />
                                    </div>
                                    <div class="row">
                                          <div class="col-md-3 mb-3">
                                                <label class="fw-0 small text-muted">* Campos Obrigatórios</label>
                                          </div>
                                    </div>
                              </div>
                        </div>
                        <div class="card-footer d-flex justify-content-end gap-2">
                              <button type="button" class="btn btn-light" @onclick="Cancelar">Cancelar</button>
                              <button type="submit" class="btn @(isEditMode ? "btn-warning" : "btn-success")">
                                    <i class="bi bi-check-circle"></i> @(isEditMode ? "Salvar Alterações" : "Concluir                              Cadastro")
                              </button>
                        </div>
                  </div>
            </EditForm>
      }

      @if (!string.IsNullOrEmpty(mensagem))
      {
            <div class="alert @(mensagem.Contains("Erro") ? "alert-danger" : "alert-info") mt-3 shadow-sm">
                  @mensagem
            </div>
      }
</div>

<style>
      .border-left-mgm {
            border-left: 5px solid #76b82a;
      }

      .table-sm td,
      .table-sm th {
            padding: 0.2rem 0.5rem !important;
            font-size: 0.85rem;
            vertical-align: middle;
      }
</style>

@code {
      private string cnpjBusca = "";
      private List<Cliente> todosClientes = new();
      private List<Cliente> clientesSugestao = new();
      private string cnpjLimpo = "";
      private string mensagem = "";
      private bool exibirFormulario = false;
      private bool isEditMode = false;
      private Cliente cliente = new();

      protected override async Task OnInitializedAsync()
      {
            // Carrega a lista completa de clientes para a busca instantânea
            using var context = await DbFactory.CreateDbContextAsync();
            todosClientes = await context.Clientes.ToListAsync();
      }

      private void OnInputBusca(ChangeEventArgs e)
      {
            cnpjBusca = e.Value?.ToString() ?? "";

            if (cnpjBusca.Length >= 2)
            {
                  clientesSugestao = todosClientes
                      .Where(c => c.RazaoSocial.Contains(cnpjBusca, StringComparison.OrdinalIgnoreCase) ||
                                  c.Cnpj.Contains(cnpjBusca))
                      .Take(8) // Mostra até 8 sugestões
                      .ToList();
            }
            else
            {
                  clientesSugestao.Clear();
            }
      }

      private void SelecionarCliente(Cliente c)
      {
            cliente = c;
            cnpjBusca = c.Cnpj;
            clientesSugestao.Clear();
            isEditMode = true;
            exibirFormulario = true;
            mensagem = "";
      }

      private async Task Buscar()
      {
            // Se o usuário clicar no botão após digitar o CNPJ completo
            if (string.IsNullOrWhiteSpace(cnpjBusca)) return;

            cnpjLimpo = new string(cnpjBusca.Where(char.IsDigit).ToArray());
            var resultado = todosClientes.FirstOrDefault(c => c.Cnpj == cnpjLimpo);

            if (resultado != null)
            {
                  SelecionarCliente(resultado);
                  mensagem = "Cliente carregado do banco.";
            }
            else
            {
                  mensagem = "CNPJ não encontrado. Clique em 'Novo Cliente' para cadastrar.";
                  exibirFormulario = false;
            }
            await Task.CompletedTask;
      }

      private void NovoCliente()
      {
            cliente = new Cliente { Cnpj = cnpjBusca };
            isEditMode = false;
            exibirFormulario = true;
            mensagem = "";
      }

      private async Task OnCepInput(ChangeEventArgs e)
      {
            var valor = e.Value?.ToString() ?? "";
            cliente.Cep = MGMFormatador.FormatarCep(valor); // Bind manual para poder disparar a lógica

            var numeros = new string(valor.Where(char.IsDigit).ToArray());

            if (numeros.Length == 8)
            {
                  var result = await CepService.BuscarEnderecoAsync(numeros);
                  if (result != null && result.Erro != true)
                  {
                        cliente.Endereco = result.Logradouro;
                        cliente.Bairro = result.Bairro;
                        cliente.Cidade = result.Localidade;
                        cliente.Uf = result.Uf;
                        cliente.MunicipioCodigoIbge = result.Ibge;

                        mensagem = $"Endereço de {result.Localidade} carregado.";
                  }
            }
      }

      private async Task HandleSubmit()
      {
            try
            {
                  // Limpa o CEP e CNPJ para salvar apenas números (Boa prática para o XML da nota)
                  cliente.Cep = new string(cliente.Cep.Where(char.IsDigit).ToArray());
                  cliente.Cnpj = new string(cliente.Cnpj.Where(char.IsDigit).ToArray());

                  // Padronização: Para Maringá sempre usamos o mesmo código IBGE
                  //cliente.MunicipioCodigoIbge = "4115200";

                  if (isEditMode)
                        await ClienteService.AtualizarAsync(cliente);
                  else
                        await ClienteService.SalvarAsync(cliente);

                  mensagem = "✅ Cliente salvo com sucesso!";
                  exibirFormulario = false;
                  cnpjBusca = "";
            }
            catch (Exception ex)
            {
                  mensagem = "❌ Erro ao salvar: " + ex.InnerException?.Message ?? ex.Message;
            }
      }

      private void Cancelar()
      {
            exibirFormulario = false;
            mensagem = "";
      }
}