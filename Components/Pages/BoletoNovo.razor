@page "/boletos/novo"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Fiscal")]
@using MGMBlazor.Domain.Entities
@using MGMBlazor.Services.Sicoob
@using MGMBlazor.Services.Clientes
@using MGMBlazor.Infrastructure.Helpers
@using static MGMBlazor.Services.Shared.EmailService
@inject ISicoobService SicoobService
@inject IClienteService ClienteService
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IConfiguration config
@inject AuditLogService AuditLog
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Novo Boleto Avulso</PageTitle>

<div class="container mt-3 pb-5">
    <!-- CABEÇALHO -->
    <div class="d-flex justify-content-between align-items-center mb-3 p-2 shadow-sm rounded bg-white border-left-mgm">
        <h4 class="m-0 fw-bold text-dark"><i class="bi bi-cash-stack"></i> Emissão de Boleto Avulso</h4>
        <button class="btn btn-sm btn-outline-secondary" @onclick='() => Nav.NavigateTo("/boletos")'>
            <i class="bi bi-arrow-left"></i> Voltar
        </button>
    </div>

    <!-- 1. BUSCA DINÂMICA DO CLIENTE (PAGADOR) -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-dark text-white py-2">
            <h6 class="mb-0 small fw-bold text-uppercase">1. Dados do Pagador</h6>
        </div>
        <div class="card-body bg-light position-relative">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label small fw-bold">BUSCAR CLIENTE</label>
                    <input type="text" class="form-control" placeholder="Nome ou CNPJ..."
                           @bind="filtroBusca" @oninput="OnInputBusca" />
                    
                    @if (clientesSugestao.Any())
                    {
                        <ul class="list-group position-absolute w-100 shadow-lg" style="z-index: 1050;">
                            @foreach (var c in clientesSugestao)
                            {
                                <button class="list-group-item list-group-item-action py-2" @onclick="() => SelecionarCliente(c)">
                                    <strong>@MGMFormatador.FormatarCnpj(c.Cnpj)</strong> - @c.RazaoSocial
                                </button>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (mostrarFormulario)
    {
        <!-- 2. DADOS FINANCEIROS -->
        <div class="card shadow-sm border-0 mb-4 animate__animated animate__fadeIn">
            <div class="card-header bg-dark text-white py-2">
                <h6 class="mb-0 small fw-bold text-uppercase">2. Configurações do Boleto</h6>
            </div>
            <div class="card-body bg-light">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small">VALOR DO BOLETO</label>
                        <div class="input-group">
                            <span class="input-group-text shadow-sm">R$</span>
                            <input type="text" class="form-control border-success fw-bold text-success" @bind="ValorExibicao" />
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small">DATA DE VENCIMENTO</label>
                        <input type="date" class="form-control" @bind="dataVencimento" />
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="fw-bold small text-uppercase">PARCELAS</label>
                        <input type="number" class="form-control" @bind="numeroParcela" min="1" max="99" />
                    </div>
                    @if (numeroParcela > 1)
                    {
                            <div class="col-md-3 mb-3 animate__animated animate__fadeIn">
                                <label class="fw-bold small text-success">PERÍODO</label>
                                <select class="form-select shadow-sm border-success" @bind="periodoSelecionado">
                                <option value="@PeriodoParcelamento.Mensal">Mensal</option>
                                <option value="@PeriodoParcelamento.Quinzenal">Quinzenal</option>
                                <option value="@PeriodoParcelamento.Semanal">Semanal</option>
                                </select>
                            </div>
                    }
                    <div class="col-md-3 mb-3">
                        <label class="fw-bold small">SEU NÚMERO (REF. INTERNA)</label>
                        <input type="text" class="form-control" @bind="seuNumero" placeholder="Ex: 2024-01" />
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="fw-bold small">NÚMERO DA NOTA</label>
                        <input type="text" class="form-control" @bind="numeroNota"       
                            placeholder="Ex: 1945" @onblur="BuscarIdDaNota" />
                            @if (idNotaEncontrado != null) {
                                <small class="text-success">✅ Nota encontrada no banco!</small>
                            } 
                    </div>
                    
                    <div class="col-md-12">
                        <div class="alert alert-info py-2 small">
                            Pagador: <strong>@pagador.RazaoSocial</strong> | CNPJ: @MGMFormatador.FormatarCnpj(pagador.Cnpj)
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer p-0 border-0">
                <button class="btn btn-primary w-100 py-3 rounded-0 fw-bold" @onclick="GerarBoleto" disabled="@processando">
                    @if (processando)
                    {
                        <span class="spinner-border spinner-border-sm"></span> <span>REGISTRANDO NO SICOOB...</span>
                    }
                    else
                    {
                        <i class="bi bi-shield-check"></i> <span>GERAR E REGISTRAR BOLETO</span>
                    }
                </button>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMsg))
    {
        <div class="alert @(statusMsg.Contains("Erro") ? "alert-danger" : "alert-success") shadow-sm">
            @statusMsg
        </div>
    }
</div>

<style>
    .border-left-mgm { border-left: 8px solid #76b82a; }
</style>

@code {
    private string filtroBusca = "";
    private string statusMsg = "";
    private bool mostrarFormulario = false;
    private bool processando = false;
    private List<Cliente> todosClientes = new();
    private List<Cliente> clientesSugestao = new();
    
    private Cliente pagador = new();
    private decimal valorBoleto = 0;
    private DateTime dataVencimento = DateTime.Today.AddDays(15);
    private int numeroParcela = 1;
    private PeriodoParcelamento periodoSelecionado = PeriodoParcelamento.Mensal;
    private string seuNumero = "";
    private string numeroNota = "";
    private int? idNotaEncontrado = null;
    private bool boletoGerado = false;

    // A propriedade que funcionou na Nota!
    private string ValorExibicao
    {
        get => MGMFormatador.FormatarMoedaParaInput(valorBoleto);
        set => valorBoleto = MGMFormatador.ConverterParaDecimal(value);
    }

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        todosClientes = await context.Clientes.ToListAsync();
    }

    private async Task BuscarIdDaNota()
    {
        if (string.IsNullOrWhiteSpace(numeroNota)) {
            idNotaEncontrado = null;
            return;
        }

        using var context = await DbFactory.CreateDbContextAsync();
        // Busca a nota pelo número oficial (string) para pegar o Id (int)
        var nota = await context.NotasFiscaisEmitidas
            .FirstOrDefaultAsync(n => n.NumeroNota == numeroNota);
        
        idNotaEncontrado = nota?.Id; // Se não achar, fica null
    }

    private void OnInputBusca(ChangeEventArgs e)
    {
        filtroBusca = e.Value?.ToString() ?? "";
        if (filtroBusca.Length >= 2)
        {
            clientesSugestao = todosClientes
                .Where(c => c.RazaoSocial.Contains(filtroBusca, StringComparison.OrdinalIgnoreCase) || c.Cnpj.Contains(filtroBusca))
                .Take(5).ToList();
        }
        else { clientesSugestao.Clear(); }
    }

    private void SelecionarCliente(Cliente c)
    {
        pagador = c;
        filtroBusca = c.RazaoSocial;
        clientesSugestao.Clear();
        mostrarFormulario = true;
    }

    private async Task GerarBoleto()
    {
        if (valorBoleto <= 0) { statusMsg = "Erro: Valor deve ser maior que zero."; return; }

        long? nossoNumeroLog = null;

        processando = true;
        try
        {
            DateTime vencimento = dataVencimento;
            string dataCobranca = vencimento.AddDays(1).ToString("yyyy-MM-dd");

            var usarSandbox = config.GetValue<bool>("SicoobConfig:UsarSandbox");
            
            var request = new BoletoRequest
            {
                NumeroCliente = usarSandbox ? 25546454 : config.GetValue<long>("SicoobConfig:NumeroCliente"),
                NumeroContaCorrente = usarSandbox ? 0 : config.GetValue<long>("SicoobConfig:NumeroContaCorrente"),
                Valor = valorBoleto,
                NumeroParcela = numeroParcela,
                SeuNumero = "MGM-" + seuNumero,
                DataEmissao = usarSandbox ? "2018-09-20" : DateTime.Now.ToString("yyyy-MM-dd"),
                DataVencimento = usarSandbox ? "2018-09-20" : dataVencimento.ToString("yyyy-MM-dd"),
                DataMulta = usarSandbox ? "2018-09-20" : dataCobranca,
                DataJurosMora = usarSandbox ? "2018-09-20" : dataCobranca,
                Pagador = new PagadorRequest
                {
                    Nome = pagador.RazaoSocial,
                    NumeroCpfCnpj = pagador.Cnpj,
                    Endereco = pagador.Endereco,
                    Cidade = pagador.Cidade,
                    Cep = pagador.Cep,
                    Bairro = pagador.Bairro,
                    Uf = pagador.Uf
                },
                GerarPdf = true
            };

            var anexosEmail = new List<BoletoAnexo>();

            if (numeroParcela > 1)
            {
                Console.WriteLine($"Entrou na geração de lote para {numeroParcela} parcelas, período: {periodoSelecionado}");

                // CHAMA O NOVO MÉTODO DE LOTE
                var resultados = await SicoobService.GerarLoteBoletosAsync(
                idNotaEncontrado, 
                request, 
                numeroParcela, 
                periodoSelecionado);

                if (resultados.Any())
                {
                    foreach (var res in resultados)
                    {
                        if (!string.IsNullOrEmpty(res.Resultado?.PdfBoleto))
                        {
                                anexosEmail.Add(new BoletoAnexo { 
                                    Base64 = res.Resultado.PdfBoleto, 
                                    NumeroParcela = res.Resultado.NumeroParcela 
                                });
                        }
                    }

                    boletoGerado = true;
                    statusMsg = $"✅ {resultados.Count} parcelas geradas com sucesso!";
                    
                    // Abre o PDF da primeira parcela para o usuário ver
                    var primeiroPdf = resultados.First().Resultado?.PdfBoleto;
                    if (!string.IsNullOrEmpty(primeiroPdf))
                        await JS.InvokeVoidAsync("abrirPdfNoNavegador", primeiroPdf);
                }
            }
            else
            {
                var resp = await SicoobService.IncluirBoletoAsync(idNotaEncontrado, request);

                if (resp?.Resultado?.PdfBoleto != null)
                {
                    nossoNumeroLog = resp.Resultado.NossoNumero;
                    anexosEmail.Add(new BoletoAnexo { 
                        Base64 = resp.Resultado.PdfBoleto, 
                        NumeroParcela = 1 
                    });
                    boletoGerado = true;

                    if (resp.Resultado.PdfBoleto.Length > 200)
                    {
                        Console.WriteLine("[INFO] PDF válido recebido. Abrindo...");
                        await JS.InvokeVoidAsync("abrirPdfNoNavegador", resp.Resultado.PdfBoleto);
                        statusMsg = "✅ Boleto gerado e registrado com sucesso!";
                    }
                    else
                    {
                        Console.WriteLine($"[AVISO] Sandbox enviou PDF incompleto ({resp.Resultado.PdfBoleto.Length} chars).");
                        statusMsg = "⚠️ Boleto gerado, mas o Sandbox do banco não enviou um PDF válido para visualização.";
                    } 
                }
            }
            if (boletoGerado)
            {
                // REGISTRO DE LOG
                var authState = await AuthProvider.GetAuthenticationStateAsync();
                var usuario = authState.User.Identity?.Name ?? "Sistema";

                string detalhes = numeroParcela > 1 
                    ? $"Lote de {numeroParcela} parcelas | Cliente: {pagador.RazaoSocial} | Total: {valorBoleto:C2}"
                    : $"Boleto Único | NossoNro: {nossoNumeroLog} | Cliente: {pagador.RazaoSocial} | Valor: {valorBoleto:C2}";

                await AuditLog.RegistrarLogAsync(usuario, "Geração de Boleto Avulso", detalhes, "Boleto Avulso");
                
                @* statusMsg = "✅ Boleto gerado! Enviando e-mail para o cliente...";
                StateHasChanged();

                // DISPARA O E-MAIL AQUI!
                bool enviouEmail = await EmailService.EnviarFaturamentoPorEmail(
                        emailCliente, 
                        linkNota!, 
                        anexosEmail, 
                        idNotaEncontrado);

                if (enviouEmail) 
                {
                        statusMsg = "✅ Processo completo: Nota, Boleto e E-mail enviados!";
                } 
                else 
                {
                        statusMsg = "⚠️ Nota e Boleto OK, mas o E-MAIL falhou. Verifique a configuração do serviço de e-mail.";
                } *@
            } 
        }
        catch (Exception ex)
        {
            statusMsg = "❌ Erro: " + ex.Message;
        }
        finally { processando = false; }
    }
}